# 【Windows】OusterLiDARをMATLABで使用する
## MATLAB側の設定
* アドオンエクスプローラーで，[Lidar Toolbox Support Package for Ouster Lidar Sensors](https://jp.mathworks.com/help/lidar/ousterlidar/ug/download-lidar-toolbox-support-package-for-ouster-sensors.html)を追加する  
* アドオンインストール後，コマンドラインで以下コマンドを入力し，エラーが出ても関数が存在していればインストール確認完了  
  ```MATLAB
  ousterlidar
  ```

## LiDAR側の設定
* [os-シリアル番号.local](http://os-sirialNumber.local/)へアクセス
* `Configuration`タブへ移動
* `UDP-Destination addres`において`Set Local`をクリック（自身のPCのアドレスに設定）

## MATLABコード用Calibration Fileの作成
**※この節ではubuntuを併用（Widows環境しかない場合にはWSLでも同様の操作は可能だが非推奨）**
* [windows] MATLABコードを実行したいディレクトリで,`ousterlidar_calib.json`を作成（名前は何でもいい）
* [ubuntu] ターミナル（[windows]では，「スタート」から「ubuntu」を検索して開く）で
  ```shell
  nc os-serial_number.local 7501
  ```
  を入力してEnter  
  * 上記コマンドを乳慮くすると，APIによって様々な情報を得ることができるようになる．APIコマンドを入力すると，jsonファイル形式の文字列が出力されるため，それを`ousterlidar_calib.json`に追記していく．  
  * 以下，必要な情報を得るためのAPI列挙  
    ```shell
    get_sensor_info
    get_lidar_data_format
    get_beam_intrinsics
    get_lidar_intrinsics
    get_imu_intrinsics
    ```  
  * 出力結果をまとめた`ousterlidar_calib.json`の一例  
    ```json ousterlidar_calib.json
    {
        "prod_line": "OS-1-128", "prod_pn": "840-103575-06", "prod_sn": "122222000542", "image_rev": "ousteros-image-prod-aries-v2.4.0+20220921174636", "build_rev": "v2.4.0", "build_date": "2022-09-21T17:47:45Z", "status": "RUNNING", "initialization_id": 7109744, "lidar_mode": "1024x20",
        "data_format": {"pixels_per_column": 128, "columns_per_packet": 16, "columns_per_frame": 1024, "pixel_shift_by_row": [12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12, 12, 4, -4, -12], "column_window": [0, 1023], "udp_profile_lidar": "LEGACY", "udp_profile_imu": "LEGACY"},
        "beam_altitude_angles": [21.62, 21.3, 20.99, 20.67, 20.39, 20.07, 19.75, 19.43, 19.15, 18.81, 18.49, 18.16, 17.88, 17.55, 17.22, 16.88, 16.6, 16.26, 15.92, 15.58, 15.29, 14.95, 14.61, 14.27, 13.97, 13.61, 13.27, 12.94, 12.64, 12.27, 11.93, 11.6, 11.29, 10.92, 10.56, 10.23, 9.92, 9.57, 9.199999999999999, 8.84, 8.539999999999999, 8.199999999999999, 7.84, 7.47, 7.16, 6.8, 6.45, 6.08, 5.76, 5.4, 5.06, 4.69, 4.38, 4.01, 3.65, 3.29, 2.98, 2.61, 2.24, 1.89, 1.57, 1.21, 0.83, 0.48, 0.16, -0.2, -0.5600000000000001, -0.93, -1.25, -1.61, -1.97, -2.34, -2.65, -3.03, -3.38, -3.74, -4.06, -4.42, -4.78, -5.14, -5.45, -5.82, -6.19, -6.55, -6.86, -7.2, -7.57, -7.95, -8.24, -8.6, -8.949999999999999, -9.32, -9.609999999999999, -9.98, -10.33, -10.68, -11, -11.33, -11.69, -12.04, -12.36, -12.69, -13.04, -13.38, -13.7, -14.03, -14.38, -14.72, -15.02, -15.36, -15.69, -16.04, -16.33, -16.68, -17, -17.33, -17.63, -17.95, -18.29, -18.61, -18.91, -19.22, -19.56, -19.86, -20.17, -20.47, -20.8, -21.11],
        "beam_azimuth_angles": [4.13, 1.31, -1.5, -4.3, 4.14, 1.33, -1.49, -4.3, 4.15, 1.33, -1.49, -4.29, 4.15, 1.34, -1.48, -4.28, 4.16, 1.35, -1.47, -4.28, 4.16, 1.35, -1.46, -4.27, 4.16, 1.35, -1.46, -4.26, 4.17, 1.35, -1.46, -4.26, 4.18, 1.36, -1.46, -4.27, 4.18, 1.38, -1.45, -4.26, 4.18, 1.38, -1.43, -4.26, 4.18, 1.37, -1.43, -4.25, 4.18, 1.37, -1.43, -4.24, 4.2, 1.38, -1.42, -4.24, 4.22, 1.4, -1.42, -4.23, 4.21, 1.41, -1.43, -4.23, 4.22, 1.41, -1.41, -4.22, 4.22, 1.41, -1.4, -4.21, 4.23, 1.41, -1.4, -4.2, 4.24, 1.43, -1.39, -4.2, 4.24, 1.43, -1.4, -4.2, 4.24, 1.44, -1.38, -4.2, 4.26, 1.43, -1.37, -4.19, 4.27, 1.44, -1.37, -4.18, 4.26, 1.46, -1.37, -4.18, 4.26, 1.46, -1.37, -4.17, 4.26, 1.47, -1.36, -4.17, 4.28, 1.46, -1.34, -4.17, 4.29, 1.47, -1.34, -4.16, 4.29, 1.5, -1.34, -4.15, 4.3, 1.5, -1.33, -4.14, 4.3, 1.49, -1.32, -4.15],
        "lidar_origin_to_beam_origin_mm": 15.806,
        "lidar_to_sensor_transform": [-1, 0, 0, 0, 0, -1, 0, 0, 0, 0, 1, 36.18, 0, 0, 0, 1],
        "imu_to_sensor_transform": [1, 0, 0, 6.253, 0, 1, 0, -11.775, 0, 0, 1, 7.645, 0, 0, 0, 1],
    }
    ```
* MATLABコマンドラインで以下を入力  
  ```MATLAB
  ousterlidar("os1-128","ousterlidar_calib.json",Port=7502)
  ```  
  上記で記述している`ousterlidar_calib.json`に足りない部分があれば，指摘されるデータを取得できるAPIコマンドを[os-シリアル番号.local](http://os-sirialNumber.local/)のdocumentationタブにて検索し，ターミナルで入力

## ===上記手順を踏んでもうまく行かない場合===
上記までの手順で，MATLABコマンドラインに
```MATLAB
Unable to read from the Ouster lidar sensor, check the configuration utility set up. The data port of the sensor must match with the port
number used while creating the object.
```
とエラーが出た場合，ESETによってOusterLiDARと繋げているイーサネットでのUDP通信がブロックされている可能性が高い．その場合，以下の手順でブロックを解除する．
* MATLABで`ousterlidar("os1-128","ousterlidar_calib.json",Port=7502)`を入力し，上記エラーが出ることを確認．
* "ESET internet security"を開く
* 「概要」タブで，ネットワークを選択